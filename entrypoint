#!/bin/bash
# This is HELL. I need to make some cleanup ..

ZONES=${ZONES:-''}
ZONES_DNSSEC=${ZONES_DNSSEC:-''}
TSIG_UPDATES=${TSIG_UPDATES:-''}
TSIG_KEYS=${TSIG_KEYS:-''}
TSIG_SLAVES=${TSIG_SLAVES:-''}
DNSTAP_SOCKET=${DNSTAP_SOCKET:-''}

[[ -d /var/lib/knot/zones/ ]] || mkdir /var/lib/knot/zones/
render.py /etc/knot/knot.conf.jinja2 > /etc/knot/knot.conf
for zone in ${ZONES_DNSSEC}; do
  if [ ! -f /var/lib/knot/zones/$zone ]; then
    echo "adding signed zone $zone"
    cp /etc/knot/zones/${zone} /var/lib/knot/zones/$zone
  else
    echo "$zone already exist."
  fi
done
echo "config dump:"
cat /etc/knot/knot.conf
chown -R knot: /var/lib/knot 
exec /usr/bin/knotd
